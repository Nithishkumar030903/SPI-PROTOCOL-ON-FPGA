module spi_master(
    input clk,
    input reset,
    input start,
    input [1:0] mode,
    input [7:0] data_in,
    output reg [7:0] data_out,
    output reg ss,
    output reg mosi,
    input miso,
    output sclk,
    output reg done
);

wire CPOL = mode[1];
wire CPHA = mode[0];

wire spi_clk;
clock_divider CD(clk, reset, 16'd50, spi_clk);

assign sclk = CPOL ? ~spi_clk : spi_clk;

reg [3:0] bit_cnt;
reg [7:0] shift_reg;

always @(posedge spi_clk or posedge reset) begin
    if (reset) begin
        bit_cnt <= 0;
        ss <= 1;
        done <= 0;
    end else begin

        if (start) begin
            ss <= 0;
            shift_reg <= data_in;
            bit_cnt <= 7;
            done <= 0;
        end

        mosi <= shift_reg[bit_cnt];
        data_out[bit_cnt] <= miso;

        if (bit_cnt == 0) begin
            ss <= 1;
            done <= 1;
        end else begin
            bit_cnt <= bit_cnt - 1;
        end

    end
end

endmodule
